<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mckpsGen - Mockups Generator</title>
    <!--<title>mckpsGen - Mockups Generator</title>-->
    <link rel="icon" type="image/png" href="favicon.png" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-primary: #1a1a1a; --bg-secondary: #242424; --bg-tertiary: #2d2d2d;
            --accent: #6366f1; --accent-hover: #818cf8; --success: #10b981; --danger: #ef4444;
            --text-primary: #e5e7eb; --text-secondary: #9ca3af; --border: #374151;
            --shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg-primary); color: var(--text-primary); overflow: hidden; font-size: 13px; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 4px; }
        .app-container { display: flex; height: 100vh; }
        .sidebar { width: 280px; background: var(--bg-secondary); display: flex; flex-direction: column; border-right: 1px solid var(--border); flex-shrink: 0; }
        .sidebar-header { padding: 14px 16px; background: var(--bg-tertiary); border-bottom: 1px solid var(--border); }
        .sidebar-header h1 { font-size: 22px; margin-bottom: 0px; display: flex; align-items: center; gap: 8px; color: var(--accent); }
        .sidebar-header p { font-size: 11px; color: var(--text-secondary); }
        .nav-menu { flex: 1; overflow-y: auto; padding: 12px; }
        .nav-section { margin-bottom: 16px; }
        .nav-section-header { padding: 8px 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-radius: 6px; transition: background 0.2s; font-weight: 600; font-size: 12px; background: var(--bg-tertiary); user-select: none; }
        .nav-section-header:hover { background: var(--bg-primary); }
        .nav-section-header .header-text { flex: 1; }
        .toggle-icon { transition: transform 0.2s; color: var(--accent); font-size: 10px; }
        .nav-section-header.collapsed .toggle-icon { transform: rotate(-90deg); }
        .nav-section-content { max-height: 1000px; overflow: hidden; transition: max-height 0.3s; }
        .nav-section-content.collapsed { max-height: 0; }
        .folder-list { list-style: none; padding: 6px 0; }
        .folder-item { padding: 8px 10px; margin: 4px 0; border-radius: 6px; cursor: pointer; transition: background 0.2s; display: flex; align-items: center; gap: 8px; font-size: 12px; user-select: none; }
        .folder-item:hover { background: var(--bg-primary); }
        .folder-item.active { background: var(--accent); color: white; }
        .folder-icon { font-size: 14px; width: 16px; text-align: center; }
        .folder-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .folder-count { background: rgba(99, 102, 241, 0.2); color: var(--accent); padding: 2px 6px; border-radius: 8px; font-size: 10px; font-weight: 700; }
        .folder-item.active .folder-count { background: rgba(255, 255, 255, 0.2); color: white; }
        .folder-delete-btn { background: none; border: none; color: inherit; cursor: pointer; padding: 4px; border-radius: 4px; opacity: 0; transition: opacity 0.2s; font-size: 11px; }
        .folder-item:hover .folder-delete-btn { opacity: 0.6; }
        .folder-delete-btn:hover { opacity: 1 !important; color: var(--danger); }
        .add-folder-btn { background: var(--accent); color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 6px; transition: background 0.2s; margin: 8px 0; font-size: 12px; }
        .add-folder-btn:hover { background: var(--accent-hover); }
        .watermark-controls { padding: 8px 0; }
        .watermark-opacity-control { margin-bottom: 10px; }
        .watermark-opacity-label { font-size: 11px; color: var(--text-secondary); margin-bottom: 6px; display: flex; justify-content: space-between; }
        .watermark-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 8px; }
        .watermark-option { aspect-ratio: 1; border: 2px solid var(--border); border-radius: 8px; cursor: pointer; transition: all 0.2s; background: var(--bg-tertiary); display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .watermark-option:hover { border-color: var(--accent); }
        .watermark-option.selected { border-color: var(--success); box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3); }
        .watermark-option img { max-width: 90%; max-height: 90%; object-fit: contain; }
        .watermark-option.none { flex-direction: column; gap: 4px; font-size: 10px; color: var(--text-secondary); }
        .sidebar-footer { padding: 12px; border-top: 1px solid var(--border); background: var(--bg-tertiary); }
        .stats-box { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
        .stat-item { background: var(--bg-primary); padding: 10px; border-radius: 6px; text-align: center; border: 1px solid var(--border); }
        .stat-value { font-size: 18px; font-weight: 700; color: var(--accent); }
        .stat-label { font-size: 10px; color: var(--text-secondary); margin-top: 2px; }
        .storage-meter { background: var(--bg-primary); border-radius: 6px; padding: 8px; margin-bottom: 8px; }
        .storage-meter-label { font-size: 10px; color: var(--text-secondary); margin-bottom: 6px; display: flex; justify-content: space-between; }
        .storage-bar { height: 6px; background: var(--bg-tertiary); border-radius: 3px; overflow: hidden; }
        .storage-fill { height: 100%; background: var(--success); transition: width 0.3s; border-radius: 3px; }
        .storage-fill.warning { background: var(--danger); }
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .templates-panel { width: 280px; background: var(--bg-secondary); border-right: 1px solid var(--border); display: flex; flex-direction: column; position: absolute; left: 0; top: 0; bottom: 0; z-index: 100; transition: transform 0.3s; }
        .templates-panel.hidden { transform: translateX(-100%); }
        .templates-toggle { position: absolute; left: 280px; top: 25%; transform: translateY(-50%); background: var(--accent); color: white; border: none; width: 24px; height: 48px; border-radius: 0 6px 6px 0; cursor: pointer; z-index: 101; transition: left 0.3s; font-size: 12px; }
        .templates-panel.hidden + .templates-toggle { left: 0; }
        .templates-toggle:hover { background: var(--accent-hover); }
        .panel-tooltip { position: absolute; left: 32px; top: 50%; transform: translateY(-50%); background: var(--bg-tertiary); color: var(--text-primary); padding: 8px 12px; border-radius: 6px; font-size: 11px; white-space: nowrap; pointer-events: none; opacity: 0; transition: opacity 0.3s; border: 1px solid var(--border); box-shadow: var(--shadow); z-index: 102; }
        .templates-toggle.show-tooltip + .panel-tooltip { opacity: 1; }
        .panel-header { padding: 14px 16px; border-bottom: 1px solid var(--border); background: var(--bg-tertiary); }
        .panel-title { font-size: 22px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .upload-options { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 12px; }
        .upload-btn { padding: 12px; border: 2px dashed var(--border); border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.2s; background: var(--bg-tertiary); font-size: 11px; }
        .upload-btn:hover { border-color: var(--accent); background: var(--bg-primary); }
        .upload-btn i { display: block; font-size: 24px; margin-bottom: 6px; color: var(--accent); }
        .mockup-list { list-style: none; padding: 0 12px 12px 12px; overflow-y: auto; flex: 1; }
        .mockup-item { padding: 10px; margin: 6px 0; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center; background: var(--bg-tertiary); font-size: 11px; }
        .mockup-item:hover { border-color: var(--accent); background: var(--bg-primary); }
        .mockup-item.selected { background: rgba(99, 102, 241, 0.2); border-color: var(--accent); }
        .mockup-name { display: flex; align-items: center; gap: 8px; flex: 1; overflow: hidden; }
        .mockup-name i { color: var(--accent); }
        .mockup-name span { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .mockup-badge { background: var(--success); color: white; padding: 2px 6px; border-radius: 6px; font-size: 9px; font-weight: 700; display: flex; align-items: center; gap: 3px; }
        .library-badge { background: var(--accent); color: white; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 700; }
        .mockup-toggle { position: relative; width: 36px; height: 18px; background: var(--border); border-radius: 9px; cursor: pointer; transition: background 0.2s; flex-shrink: 0; }
        .mockup-toggle.enabled { background: var(--success); }
        .mockup-toggle-slider { position: absolute; top: 2px; left: 2px; width: 14px; height: 14px; background: white; border-radius: 50%; transition: transform 0.2s; }
        .mockup-toggle.enabled .mockup-toggle-slider { transform: translateX(18px); }
        .mockup-item.disabled { opacity: 0.5; }
        .mockup-folder-btn, .delete-mockup-btn { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 6px; border-radius: 4px; transition: all 0.2s; font-size: 11px; }
        .mockup-folder-btn:hover { background: var(--bg-primary); color: var(--accent); }
        .delete-mockup-btn:hover { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .preview-section { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-bar { padding: 12px 16px; border-bottom: 1px solid var(--border); background: var(--bg-secondary); display: flex; justify-content: space-between; align-items: center; }
        .top-bar h2 { font-size: 16px; display: flex; align-items: center; gap: 8px; }
        .folder-badge { background: var(--accent); color: white; padding: 3px 8px; border-radius: 8px; font-size: 10px; margin-left: 8px; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 12px; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover:not(:disabled) { background: var(--accent-hover); }
        .btn-success { background: var(--success); color: white; }
        .btn-success:hover:not(:disabled) { opacity: 0.9; }
        .btn-secondary { background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary); }
        .btn-secondary:hover:not(:disabled) { background: var(--bg-primary); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .generator-wrapper { flex: 1; display: flex; overflow: hidden; }
        .preview-wrapper { flex: 1; background: var(--bg-primary); display: flex; align-items: center; justify-content: center; overflow: hidden; padding: 16px; position: relative; }
        .preview-container { position: relative; width: 100%; height: 100%; max-width: 100%; max-height: 100%; display: flex; align-items: center; justify-content: center; }
        .watermark-preview-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; display: none; }
        .watermark-preview-overlay.active { display: block; }
        .watermark-preview-overlay canvas { width: 100%; height: 100%; object-fit: contain; }
        #mockupPreview { max-width: 100%; max-height: 100%; width: auto; height: auto; object-fit: contain; display: none; box-shadow: var(--shadow); border-radius: 8px; }
        #mockupPreview.visible { display: block; }
        .preview-placeholder { text-align: center; color: var(--text-secondary); }
        .preview-placeholder i { font-size: 64px; margin-bottom: 12px; opacity: 0.3; }
        .design-wrapper { position: absolute; border: 2px dashed var(--accent); cursor: move; background: rgba(99, 102, 241, 0.05); min-width: 50px; min-height: 50px; }
        .design-wrapper.active { border-color: var(--success); border-style: solid; background: rgba(16, 185, 129, 0.05); box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3); }
        .design-placeholder { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; color: var(--accent); text-align: center; padding: 6px; }
        .resize-handle { position: absolute; right: -8px; bottom: -8px; width: 16px; height: 16px; background: var(--accent); border: 2px solid white; cursor: nwse-resize; border-radius: 50%; z-index: 10; }
        .rotate-handle { position: absolute; top: -28px; left: 50%; transform: translateX(-50%); width: 24px; height: 24px; background: var(--success); border-radius: 50%; cursor: grab; display: flex; align-items: center; justify-content: center; color: white; font-size: 12px; z-index: 10; }
        .remove-handle { position: absolute; top: -12px; right: -12px; width: 24px; height: 24px; background: var(--danger); color: white; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; z-index: 10; }
        .element-label { position: absolute; top: -26px; left: 0; background: var(--accent); color: white; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; white-space: nowrap; }
        .controls-panel { width: 240px; background: var(--bg-secondary); border-left: 1px solid var(--border); display: flex; flex-direction: column; overflow-y: auto; }
        .controls-section { padding: 12px; border-bottom: 1px solid var(--border); }
        .controls-title { font-size: 12px; font-weight: 600; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
        .aspect-ratio-group { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 6px; max-height: 200px; overflow-y: auto; }
        .aspect-btn { padding: 8px; border: 1px solid var(--border); background: var(--bg-tertiary); border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600; transition: all 0.2s; color: var(--text-primary); position: relative; }
        .aspect-btn:hover { border-color: var(--accent); }
        .aspect-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        .aspect-btn.custom-ratio { background: rgba(99, 102, 241, 0.1); }
        .aspect-btn.custom-ratio .delete-ratio-btn { position: absolute; top: -4px; right: -4px; width: 16px; height: 16px; background: var(--danger); color: white; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; border: 2px solid var(--bg-secondary); }
        .aspect-btn.custom-ratio:hover .delete-ratio-btn { display: flex; }
        .aspect-btn.custom-btn { grid-column: span 3; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .aspect-btn.custom-btn.editing { padding: 4px; }
        .aspect-btn.custom-btn.editing input { flex: 1; padding: 6px; border: 1px solid var(--border); border-radius: 4px; font-size: 11px; background: var(--bg-primary); color: var(--text-primary); text-align: center; min-width: 0; }
        .aspect-btn.custom-btn.editing input:focus { outline: none; border-color: var(--accent); }
        .aspect-btn.custom-btn.editing span { color: var(--text-secondary); }
        .aspect-btn.custom-btn.editing button { flex-shrink: 0; padding: 6px 10px; }
        input[type="range"] { width: 100%; height: 6px; border-radius: 3px; background: var(--bg-tertiary); outline: none; -webkit-appearance: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%; background: var(--accent); cursor: pointer; }
        input[type="text"], input[type="number"] { padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 11px; background: var(--bg-tertiary); color: var(--text-primary); }
        input[type="text"]:focus, input[type="number"]:focus { outline: none; border-color: var(--accent); }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: var(--bg-secondary); border-radius: 12px; padding: 24px; max-width: 900px; width: 90%; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
        .modal-header h3 { font-size: 16px; color: var(--accent); }
        .close-modal { background: var(--bg-tertiary); border: none; font-size: 20px; cursor: pointer; color: var(--text-secondary); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .close-modal:hover { background: var(--danger); color: white; }
        .library-categories { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 16px; }
        .category-btn { padding: 14px; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; text-align: center; transition: all 0.2s; background: var(--bg-tertiary); font-size: 11px; }
        .category-btn:hover { border-color: var(--accent); }
        .category-btn.active { border-color: var(--accent); background: rgba(99, 102, 241, 0.2); }
        .category-btn i { display: block; font-size: 28px; margin-bottom: 8px; color: var(--accent); }
        .library-actions { display: flex; gap: 8px; margin-bottom: 16px; justify-content: space-between; align-items: center; }
        .library-selection-info { background: rgba(99, 102, 241, 0.2); color: var(--accent); font-weight: 600; font-size: 11px; padding: 6px 12px; border-radius: 6px; }
        .library-mockups { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; }
        .library-mockup-item { border: 1px solid var(--border); border-radius: 8px; overflow: hidden; cursor: pointer; transition: all 0.2s; background: var(--bg-tertiary); position: relative; }
        .library-mockup-item:hover { border-color: var(--accent); }
        .library-mockup-item.selected { border-color: var(--success); box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3); }
        .library-mockup-item.already-added { opacity: 0.4; cursor: not-allowed; pointer-events: none; }
        .library-mockup-item.already-added::after { content: 'Added'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-primary); color: var(--text-secondary); padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 600; border: 1px solid var(--border); }
        .library-mockup-checkbox { position: absolute; top: 8px; right: 8px; width: 20px; height: 20px; border: 2px solid white; border-radius: 4px; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 10; font-size: 11px; }
        .library-mockup-item.selected .library-mockup-checkbox { background: var(--success); border-color: var(--success); }
        .library-mockup-checkbox i { color: white; display: none; }
        .library-mockup-item.selected .library-mockup-checkbox i { display: block; }
        .library-mockup-img { width: 100%; aspect-ratio: 1; object-fit: cover; background: var(--bg-primary); }
        .library-mockup-name { padding: 8px; font-size: 11px; text-align: center; border-top: 1px solid var(--border); }
        .folder-icon-grid, .folder-color-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin: 12px 0; }
        .folder-icon-option, .folder-color-option { padding: 10px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 16px; background: var(--bg-tertiary); }
        .folder-icon-option:hover, .folder-color-option:hover { border-color: var(--accent); }
        .folder-icon-option.selected, .folder-color-option.selected { border-color: var(--accent); background: rgba(99, 102, 241, 0.2); }
        .folder-color-option { height: 40px; }
        .progress-bar { height: 40px; background: var(--bg-tertiary); border-radius: 8px; overflow: hidden; margin-bottom: 12px; }
        .progress-fill { height: 100%; background: var(--accent); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px; }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
        .empty-state i { font-size: 48px; margin-bottom: 12px; opacity: 0.3; }
        .loading-spinner { border: 4px solid var(--bg-tertiary); border-top: 4px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .folder-context-menu { position: absolute; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; box-shadow: var(--shadow); z-index: 1000; min-width: 180px; padding: 6px; }
        .folder-context-menu-item { padding: 8px 10px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.2s; font-size: 11px; }
        .folder-context-menu-item:hover { background: var(--bg-primary); }
    </style>
</head><body>
    <div class="app-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <h1><i class="fas fa-shirt"></i>mckpsGen Pro</h1>
                <!--<p>Mockup Generator</p>-->
            </div>
            <div class="nav-menu">
                <div class="nav-section">
                    <div class="nav-section-header" id="foldersToggle">
                        <span><i class="fas fa-folder"></i> Folders</span>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                    <div class="nav-section-content" id="foldersContent">
                        <ul class="folder-list" id="folderList"></ul>
                        <button class="add-folder-btn" id="addFolderBtnInline" style="width:100%;">
                            <i class="fas fa-plus"></i><span>New Folder</span>
                        </button>
                    </div>
                </div>
                <div class="nav-section">
                    <div class="nav-section-header" id="watermarksToggle">
                        <span><i class="fas fa-droplet"></i> Watermark</span>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </div>
                    <div class="nav-section-content" id="watermarksContent">
                        <div class="watermark-controls">
                            <div class="watermark-opacity-control">
                                <div class="watermark-opacity-label">
                                    <span>Opacity</span>
                                    <span id="watermarkOpacityValue">50%</span>
                                </div>
                                <input type="range" id="watermarkOpacitySlider" min="0" max="1" step="0.01" value="0.5">
                            </div>
                            <div class="watermark-grid" id="watermarkGrid"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="sidebar-footer">
                <div class="stats-box">
                    <div class="stat-item">
                        <div class="stat-value" id="mockupCount">0</div>
                        <div class="stat-label">Templates</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="storagePercent">0%</div>
                        <div class="stat-label">Storage</div>
                    </div>
                </div>
                <div class="storage-meter">
                    <div class="storage-meter-label">
                        <span>Used</span>
                        <span id="storageSize">0 MB</span>
                    </div>
                    <div class="storage-bar">
                        <div class="storage-fill" id="storageFill"></div>
                    </div>
                </div>
                <button class="btn btn-secondary" style="width: 100%;" onclick="clearStorage()">
                    <i class="fas fa-trash"></i><span>Clear Data</span>
                </button>
            </div>
        </div>
        <div class="main-content">
            <div class="templates-panel" id="templatesPanel">
                <div class="panel-header">
                    <div class="panel-title">
                        <i class="fas fa-images"></i>Templates
                    </div>
                </div>
                <div class="upload-options">
                    <div class="upload-btn" id="uploadDesktopBtn">
                        <i class="fas fa-upload"></i><div>Upload</div>
                    </div>
                    <div class="upload-btn" id="browseLibraryBtn">
                        <i class="fas fa-book"></i><div>Library</div>
                    </div>
                </div>
                <ul class="mockup-list" id="mockupList">
                    <li class="empty-state"><i class="fas fa-images"></i><p>No templates</p></li>
                </ul>
            </div>
            <button class="templates-toggle" id="templatesToggle"><i class="fas fa-chevron-left"></i></button>
            <div class="panel-tooltip" id="panelTooltip">Click to hide/show templates</div>
            <div class="preview-section">
                <div class="top-bar">
                    <h2><i class="fas fa-layer-group"></i>Workspace<span class="folder-badge" id="currentFolderBadge" style="display: none;"></span></h2>
                    <button class="btn btn-success" id="loadExportBtn" disabled><i class="fas fa-rocket"></i><span>Generate</span></button>
                </div>
                <div class="generator-wrapper">
                    <div class="preview-wrapper">
                        <div class="preview-container" id="previewContainer">
                            <div class="preview-placeholder"><i class="fas fa-image"></i><p>Select a template</p></div>
                            <img id="mockupPreview" alt="Mockup Preview">
                            <div class="watermark-preview-overlay" id="watermarkPreviewOverlay">
                                <canvas id="watermarkPreviewCanvas"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="controls-panel">
                        <div class="controls-section">
                            <div class="controls-title"><i class="fas fa-crop"></i>Aspect Ratio</div>
                            <div class="aspect-ratio-group" id="aspectRatioGrid"></div>
                        </div>
                        <div class="controls-section">
                            <div class="controls-title"><i class="fas fa-adjust"></i>Element Opacity</div>
                            <input type="range" id="opacitySlider" min="0" max="1" step="0.01" value="1" disabled>
                            <div style="text-align: center; margin-top: 6px; font-weight: 600; color: var(--accent); font-size: 11px;">
                                <span id="opacityValue">100%</span>
                            </div>
                        </div>
                      
<div class="controls-section">
    <div class="controls-title"><i class="fas fa-palette"></i>Blend Mode</div>
    <select id="blendModeSelect" disabled style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 11px;">
        <option value="source-over">Normal</option>
        <option value="multiply">Multiply</option>
        <option value="screen">Screen</option>
        <option value="overlay">Overlay</option>
        <option value="darken">Darken</option>
        <option value="lighten">Lighten</option>
        <option value="color-dodge">Color Dodge</option>
        <option value="color-burn">Color Burn</option>
        <option value="hard-light">Hard Light</option>
        <option value="soft-light">Soft Light</option>
        <option value="difference">Difference</option>
        <option value="exclusion">Exclusion</option>
    </select>
</div>

<div class="controls-section">
    <div class="controls-title"><i class="fas fa-sun"></i>Brightness</div>
    <input type="range" id="brightnessSlider" min="0" max="2" step="0.01" value="1" disabled>
    <div style="text-align: center; margin-top: 6px; font-weight: 600; color: var(--accent); font-size: 11px;">
        <span id="brightnessValue">100%</span>
    </div>
</div>

<div class="controls-section">
    <div class="controls-title"><i class="fas fa-adjust"></i>Contrast</div>
    <input type="range" id="contrastSlider" min="0" max="2" step="0.01" value="1" disabled>
    <div style="text-align: center; margin-top: 6px; font-weight: 600; color: var(--accent); font-size: 11px;">
        <span id="contrastValue">100%</span>
    </div>
</div>
                      
                        <div class="controls-section">
                            <button class="btn btn-primary" id="addPngBtn" disabled style="width: 100%; margin-bottom: 8px;">
                                <i class="fas fa-plus"></i><span>Add Design Area</span>
                            </button>
                            <button class="btn btn-success" id="savePositionBtn" disabled style="width: 100%;">
                                <i class="fas fa-save"></i><span>Save Position</span>
                            </button>
                            
                            <!-- ADD THIS ENTIRE DIV -->
                            <div id="autoSaveIndicator" style="text-align: center; margin-top: 8px; font-size: 11px; color: var(--success); opacity: 0; transition: opacity 0.3s;">
                                <i class="fas fa-check-circle"></i> Saved
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <input type="file" id="mockupFilesInput" accept="image/*" multiple style="display: none;">
    <input type="file" id="designPngsInput" accept="image/png,image/jpg,image/jpeg" multiple style="display: none;">
    <div class="modal" id="libraryModal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h3><i class="fas fa-book"></i> Mockup Library</h3>
                <button class="close-modal" id="closeLibraryModal">&times;</button>
            </div>
            <div class="library-categories" id="libraryCategories"></div>
            <div class="library-actions">
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" id="selectAllBtn"><i class="fas fa-check-double"></i><span>Select All</span></button>
                    <button class="btn btn-secondary" id="deselectAllBtn"><i class="fas fa-times"></i><span>Deselect All</span></button>
                </div>
                <div class="library-selection-info" id="librarySelectionInfo">0 selected</div>
            </div>
            <div id="libraryLoadingState" style="display: none;">
                <div class="loading-spinner"></div>
                <p style="text-align: center; color: var(--text-secondary); font-size: 11px;">Loading...</p>
            </div>
            <div class="library-mockups" id="libraryMockups"></div>
            <button class="btn btn-primary" id="addSelectedMockupsBtn" disabled style="width: 100%; margin-top: 16px;">
                <i class="fas fa-plus"></i><span>Add Selected to Workspace</span>
            </button>
        </div>
    </div>
    <div class="modal" id="folderModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-folder-plus"></i> Create Folder</h3>
                <button class="close-modal" id="cancelFolderBtn">&times;</button>
            </div>
            <div>
                <label style="display: block; margin-bottom: 6px; font-weight: 600; font-size: 12px;">Name</label>
                <input type="text" id="folderNameInput" placeholder="My Folder" style="width: 100%; padding: 10px;">
                <label style="display: block; margin: 14px 0 8px; font-weight: 600; font-size: 12px;">Icon</label>
                <div class="folder-icon-grid">
                    <div class="folder-icon-option selected" data-icon="fa-folder"><i class="fas fa-folder"></i></div>
                    <div class="folder-icon-option" data-icon="fa-heart"><i class="fas fa-heart"></i></div>
                    <div class="folder-icon-option" data-icon="fa-star"><i class="fas fa-star"></i></div>
                    <div class="folder-icon-option" data-icon="fa-fire"><i class="fas fa-fire"></i></div>
                    <div class="folder-icon-option" data-icon="fa-bolt"><i class="fas fa-bolt"></i></div>
                    <div class="folder-icon-option" data-icon="fa-crown"><i class="fas fa-crown"></i></div>
                </div>
                <label style="display: block; margin: 14px 0 8px; font-weight: 600; font-size: 12px;">Color</label>
                <div class="folder-color-grid">
                    <div class="folder-color-option selected" data-color="#667eea" style="background: #667eea;"></div>
                    <div class="folder-color-option" data-color="#f093fb" style="background: #f093fb;"></div>
                    <div class="folder-color-option" data-color="#4facfe" style="background: #4facfe;"></div>
                    <div class="folder-color-option" data-color="#43e97b" style="background: #43e97b;"></div>
                    <div class="folder-color-option" data-color="#fa709a" style="background: #fa709a;"></div>
                    <div class="folder-color-option" data-color="#feca57" style="background: #feca57;"></div>
                </div>
                <button class="btn btn-primary" id="createFolderBtn" style="width: 100%; margin-top: 16px;">
                    <i class="fas fa-check"></i><span>Create</span>
                </button>
            </div>
        </div>
    </div>
    <div class="modal" id="progressModal">
        <div class="modal-content" style="max-width: 400px;">
            <h3 style="margin-bottom: 16px; text-align: center; font-size: 14px;">
                <i class="fas fa-spinner fa-spin"></i> Processing...
            </h3>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
            </div>
            <p id="progressText" style="text-align: center; color: var(--text-secondary); font-size: 11px;">Preparing...</p>
        </div>
    </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
const LIBRARY_CONFIG = {
    baseUrl: 'https://raw.githubusercontent.com/dfmhub/mckps/refs/heads/main/mckps/',
    categories: {
        kids_mockups: { name: 'Kids', icon: 'fa-child', mockups: ['Kids1.jpg', 'Kids2.jpg'], thumbnailFolder: 'kids_thumbnails' },
        family_mockups: { name: 'Family', icon: 'fa-people-group', mockups: ['Family1.jpg', 'Family2.png', 'Family3.png', 'Family4.jpg', 'Family5.jpg', 'Family6.png', 'Family7.png'], thumbnailFolder: 'family_thumbnails' },
        flat_mockups: { name: 'Flat Lay', icon: 'fa-layer-group', mockups: ['Flat1.jpg', 'Flat2.jpg', 'Flat3.jpg', 'Flat4.jpg', 'Flat5.jpg', 'Flat6.jpg', 'Flat7.jpg', 'Flat8.jpg', 'Flat9.jpg', 'Flat10.jpg', 'Flat11.jpg', 'Flat12.jpg', 'Flat13.jpg', 'Flat14.jpg', 'Flat15.jpg', 'Flat16.jpg', 'Flat17.jpg', 'Flat18.jpg', 'Flat19.jpg', 'Flat20.jpg', 'Flat21.jpg', 'Flat22.jpg', 'Flat23.jpg', 'Flat24.jpg'], thumbnailFolder: 'flat_thumbnails' },
        men_mockups: { name: 'Men', icon: 'fa-person', mockups: ['Men1.jpg', 'Men2.jpg', 'Men3.jpg', 'Men4.jpg', 'Men5.jpg', 'Men6.jpg', 'Men7.jpg', 'Men8.jpg', 'Men9.jpg', 'Men10.jpg', 'Men11.jpg', 'Men12.jpg', 'Men13.jpg', 'Men14.jpg', 'Men15.jpg', 'Men16.jpg', 'Men17.jpg', 'Men18.jpg', 'Men19.jpg', 'Men20.jpg', 'Men21.jpg', 'Men22.jpg', 'Men23.jpg', 'Men24.jpg', 'Men25.jpg', 'Men26.jpg', 'Men27.jpg', 'Men28.jpg', 'Men29.jpg', 'Men30.jpg', 'Men31.jpg', 'Men32.jpg', 'Men33.jpg', 'Men34.jpg', 'Men35.jpg', 'Men36.jpg', 'Men37.jpg', 'Men38.jpg', 'Men39.jpg', 'Men40.jpg', 'Men41.jpg', 'Men42.jpg', 'Men43.jpg', 'Men44.jpg', 'Men45.jpg', 'Men46.jpg', 'Men47.jpg', 'Men48.jpg', 'Men49.jpg', 'Men50.jpg', 'Men51.jpg', 'Men52.jpg', 'Men53.jpg', 'Men54.jpg', 'Men55.jpg', 'Men56.jpg', 'Men57.jpg', 'Men58.jpg', 'Men59.jpg', 'Men60.jpg', 'Men61.jpg', 'Men62.jpg', 'Men63.jpg', 'Men64.jpg', 'Men65.jpg', 'Men66.jpg', 'Men67.jpg', 'Men68.jpg', 'Men69.jpg', 'Men70.jpg', 'Men71.jpg', 'Men72.jpg', 'Men73.jpg', 'Men74.jpg', 'Men75.jpg', 'Men76.jpg', 'Men77.jpg', 'Men78.jpg', 'Men79.jpg', 'Men80.jpg', 'Men81.jpg', 'Men82.jpg', 'Men83.jpg', 'Men84.jpg', 'Men85.jpg', 'Men86.jpg', 'Men87.jpg', 'Men88.jpg', 'Men89.jpg', 'Men90.jpg', 'Men91.jpg', 'Men92.jpg', 'Men93.jpg', 'Men94.jpg', 'Men95.jpg', 'Men96.jpg', 'Men97.jpg', 'Men98.jpg', 'Men99.jpg', 'Men100.jpg'], thumbnailFolder: 'men_thumbnails' },
        women_mockups: { name: 'Women', icon: 'fa-person-dress', mockups: ['Women1.jpg', 'Women2.jpg', 'Women3.jpg', 'Women4.jpg', 'Women5.jpg', 'Women6.jpg', 'Women7.jpg', 'Women8.jpg', 'Women9.jpg', 'Women10.jpg', 'Women11.jpg', 'Women12.jpg', 'Women13.jpg', 'Women14.jpg', 'Women15.jpg', 'Women16.jpg', 'Women17.jpg', 'Women18.jpg', 'Women19.jpg', 'Women20.jpg', 'Women21.jpg', 'Women22.jpg'], thumbnailFolder: 'women_thumbnails' }
    },
    watermarks: { baseUrl: 'https://raw.githubusercontent.com/awrdj/t00ls/refs/heads/main/mockupsGen/mckps/wtrmrks/', files: ['Watermark1.png', 'Watermark2.png', 'Watermark3.png'] }
};
const DEFAULT_ASPECT_RATIOS = ['5:6', '2:3', '4:5', '3:4', '1:1', 'free'];
const DB_NAME = 'mckpsGenDB', DB_VERSION = 1, STORE_NAME = 'mockups';
let db;

function initDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onerror = () => reject(request.error);
        request.onsuccess = () => { db = request.result; resolve(db); };
        request.onupgradeneeded = (event) => {
            db = event.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                const objectStore = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                objectStore.createIndex('name', 'name', { unique: false });
            }
        };
    });
}

function saveMockupToDB(mockup) {
    return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const objectStore = transaction.objectStore(STORE_NAME);
        const request = objectStore.put(mockup);
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
    });
}

function getAllMockupsFromDB() {
    return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const objectStore = transaction.objectStore(STORE_NAME);
        const request = objectStore.getAll();
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

function deleteMockupFromDB(id) {
    return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const objectStore = transaction.objectStore(STORE_NAME);
        const request = objectStore.delete(id);
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
    });
}

function clearAllDB() {
    return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const objectStore = transaction.objectStore(STORE_NAME);
        const request = objectStore.clear();
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
    });
}

async function getDBSize() {
    try {
        const mockups = await getAllMockupsFromDB();
        let totalSize = 0;
        for (const mockup of mockups) {
            if (mockup.dataUrl) {
                const base64Data = mockup.dataUrl.split(',')[1] || mockup.dataUrl;
                totalSize += base64Data.length * 0.75;
            }
        }
        return totalSize;
    } catch (error) { return 0; }
}

const state = {
    mockups: [], currentMockup: null, designElements: [], activeElement: null,

    defaultBlendMode: 'source-over',
    defaultBrightness: 1.0,
    defaultContrast: 1.0,

    savedMockupData: {}, currentAspectRatio: '5:6', customAspectRatios: [],
    mockupEnabled: {}, folders: [], currentFolderId: 'all', mockupToFolder: {},
    selectedWatermark: null, watermarkImages: {}, watermarkOpacity: 0.5,
    selectedLibraryMockups: new Set(), currentLibraryCategory: null,
    templatesPanelVisible: true, hasSeenTooltip: false
};
let elementIdCounter = 0, selectedFolderIcon = 'fa-folder', selectedFolderColor = '#667eea';

        // ADD THESE LINES
let autoSaveTimeout = null;
const AUTO_SAVE_DELAY = 1500; // 1.5 seconds after user stops adjusting

function loadCustomAspectRatios() {
    try {
        const saved = localStorage.getItem('mckpsGen_custom_ratios');
        if (saved) state.customAspectRatios = JSON.parse(saved);
    } catch (e) { state.customAspectRatios = []; }
}

function saveCustomAspectRatios() {
    try { localStorage.setItem('mckpsGen_custom_ratios', JSON.stringify(state.customAspectRatios)); } catch (e) {}
}

function toggleTemplatesPanel() {
    const panel = document.getElementById('templatesPanel');
    const toggle = document.getElementById('templatesToggle');
    state.templatesPanelVisible = !state.templatesPanelVisible;
    if (state.templatesPanelVisible) {
        panel.classList.remove('hidden');
        toggle.innerHTML = '<i class="fas fa-chevron-left"></i>';
    } else {
        panel.classList.add('hidden');
        toggle.innerHTML = '<i class="fas fa-chevron-right"></i>';
    }
}

// FIX #1: Proper event listeners for folder header click and folder double-click
function initTemplatesPanel() {
    const toggle = document.getElementById('templatesToggle');
    const hasSeenTooltip = localStorage.getItem('mckpsGen_seen_tooltip');
    if (!hasSeenTooltip) {
        setTimeout(() => {
            toggle.classList.add('show-tooltip');
            setTimeout(() => {
                toggle.classList.remove('show-tooltip');
                localStorage.setItem('mckpsGen_seen_tooltip', 'true');
            }, 3000);
        }, 1000);
    }

    // Toggle button click
    toggle.addEventListener('click', toggleTemplatesPanel);

    // FIX: Folder header click - toggle templates panel when clicking on text
    /* const foldersHeader = document.getElementById('foldersToggle');
    foldersHeader.addEventListener('click', function(e) {
        // If clicking the toggle icon, just collapse/expand
        if (e.target.classList.contains('toggle-icon') || e.target.closest('.toggle-icon')) {
            const content = document.getElementById('foldersContent');
            this.classList.toggle('collapsed');
            content.classList.toggle('collapsed');
        } else {
            // Clicking header text or anywhere else on header = toggle templates panel
            toggleTemplatesPanel();
        }
    });*/

    const foldersHeader = document.getElementById('foldersToggle');
    foldersHeader.addEventListener('click', function(e) {
        const content = document.getElementById('foldersContent');
        this.classList.toggle('collapsed');
        content.classList.toggle('collapsed');
    });
    
}

// FIX: Double-click folder item to toggle templates panel
function setupFolderDoubleClick() {
    // Use event delegation on folder list
    const folderList = document.getElementById('folderList');
    if (folderList) {
        folderList.addEventListener('dblclick', function(e) {
            const folderItem = e.target.closest('.folder-item');
            if (folderItem) {
                toggleTemplatesPanel();
            }
        });
    }
}

function autoHideTemplatesPanel() {
    if (state.templatesPanelVisible) {
        setTimeout(() => { toggleTemplatesPanel(); }, 300);
    }
}

function saveFoldersToDB() {
    try {
        localStorage.setItem('mckpsGen_folders', JSON.stringify(state.folders));
        localStorage.setItem('mckpsGen_mockup_folders', JSON.stringify(state.mockupToFolder));
        localStorage.setItem('mckpsGen_current_folder', state.currentFolderId);
    } catch (e) {}
}

function loadFoldersFromDB() {
    try {
        const savedFolders = localStorage.getItem('mckpsGen_folders');
        const savedMockupFolders = localStorage.getItem('mckpsGen_mockup_folders');
        const savedCurrentFolder = localStorage.getItem('mckpsGen_current_folder');
        if (savedFolders) state.folders = JSON.parse(savedFolders);
        else state.folders = [{ id: 'all', name: 'All Mockups', icon: 'fa-images', color: '#667eea' }];
        if (savedMockupFolders) state.mockupToFolder = JSON.parse(savedMockupFolders);
        if (savedCurrentFolder) state.currentFolderId = savedCurrentFolder;
    } catch (e) {
        state.folders = [{ id: 'all', name: 'All Mockups', icon: 'fa-images', color: '#667eea' }];
    }
}

function createFolder(name, icon = 'fa-folder', color = '#667eea') {
    const folderId = 'folder_' + Date.now();
    state.folders.push({ id: folderId, name: name, icon: icon, color: color });
    saveFoldersToDB();
    renderFolderList();
    setupFolderDoubleClick(); // Re-setup after rendering
    return folderId;
}

window.deleteFolder = function(folderId) {
    if (folderId === 'all') return;
    if (!confirm('Delete folder and all its templates?')) return;
    const mockupsInFolder = getMockupsInFolder(folderId);
    mockupsInFolder.forEach(mockup => { deleteMockupSilently(mockup.id); });
    state.folders = state.folders.filter(f => f.id !== folderId);
    if (state.currentFolderId === folderId) state.currentFolderId = 'all';
    delete state.savedMockupData[folderId];
    saveFoldersToDB();
    savePositionsToStorage();
    renderFolderList();
    renderMockupList();
    updateCurrentFolderBadge();
    setupFolderDoubleClick(); // Re-setup after rendering
};

function assignMockupToFolder(mockupId, folderId) {
    const mockup = state.mockups.find(m => m.id === mockupId);
    if (!mockup) return;
    const mockupsInTargetFolder = getMockupsInFolder(folderId);
    const duplicate = mockupsInTargetFolder.find(m => m.name === mockup.name);
    if (duplicate && folderId !== 'all') {
        alert(`"${mockup.name}" already exists in that folder!`);
        return;
    }
    if (folderId === 'all') delete state.mockupToFolder[mockupId];
    else state.mockupToFolder[mockupId] = folderId;
    saveFoldersToDB();
    renderMockupList();
    renderFolderList();
    setupFolderDoubleClick(); // Re-setup after rendering
}

function getMockupsInFolder(folderId) {
    if (folderId === 'all') return state.mockups;
    return state.mockups.filter(m => state.mockupToFolder[m.id] === folderId);
}

function getMockupCount(folderId) {
    return getMockupsInFolder(folderId).length;
}

function switchFolder(folderId) {
    if (state.currentMockup && state.designElements.length > 0) { saveCurrentMockupElements(); }
    state.currentFolderId = folderId;
    saveFoldersToDB();
    renderFolderList();
    renderMockupList();
    updateCurrentFolderBadge();
    updateGenerateButton();
    state.currentMockup = null;
    document.getElementById('mockupPreview').classList.remove('visible');
    document.querySelector('.preview-placeholder').style.display = 'block';
    clearDesignElements();
    document.getElementById('addPngBtn').disabled = true;
    setupFolderDoubleClick(); // Re-setup after rendering
}

function updateCurrentFolderBadge() {
    const badge = document.getElementById('currentFolderBadge');
    const folder = state.folders.find(f => f.id === state.currentFolderId);
    if (badge && folder) {
        badge.textContent = folder.name;
        badge.style.display = 'inline-block';
    }
}

function renderFolderList() {
    const folderList = document.getElementById('folderList');
    if (!folderList) return;
    folderList.innerHTML = '';
    for (const folder of state.folders) {
        const count = getMockupCount(folder.id);
        const li = document.createElement('li');
        li.className = 'folder-item';
        if (folder.id === state.currentFolderId) li.classList.add('active');
        const deleteBtn = folder.id !== 'all' ? 
            `<button class="folder-delete-btn" onclick="event.stopPropagation(); deleteFolder('${folder.id}')"><i class="fas fa-trash"></i></button>` : '';
        li.innerHTML = `
            <i class="fas ${folder.icon} folder-icon" style="color: ${folder.id === state.currentFolderId ? 'white' : folder.color};"></i>
            <span class="folder-name">${folder.name}</span>
            ${deleteBtn}
            <span class="folder-count">${count}</span>
        `;
        // li.onclick = () => switchFolder(folder.id);
        li.onclick = () => {
            switchFolder(folder.id);
            // toggleTemplatesPanel(); // Always toggle on click
            // If templates panel is hidden, show it
            if (!state.templatesPanelVisible) {
                toggleTemplatesPanel();
            }
        };

        folderList.appendChild(li);
    }
}

function mockupExistsInCurrentFolder(filename) {
    const mockupsInFolder = getMockupsInFolder(state.currentFolderId);
    return mockupsInFolder.some(m => m.name === filename);
}

function getMockupFilenamesInCurrentFolder() {
    const mockupsInFolder = getMockupsInFolder(state.currentFolderId);
    return mockupsInFolder.map(m => m.name);
}

// FIX #2: Custom aspect ratio button that transforms IN PLACE
function renderAspectRatios() {
    const grid = document.getElementById('aspectRatioGrid');
    grid.innerHTML = '';

    DEFAULT_ASPECT_RATIOS.forEach(ratio => {
        const btn = document.createElement('button');
        btn.className = 'aspect-btn';
        if (ratio === state.currentAspectRatio) btn.classList.add('active');
        btn.dataset.ratio = ratio;
        btn.textContent = ratio === 'free' ? 'Free' : ratio;
        btn.addEventListener('click', () => selectAspectRatio(ratio));
        grid.appendChild(btn);
    });

    state.customAspectRatios.forEach(ratio => {
        const btn = document.createElement('button');
        btn.className = 'aspect-btn custom-ratio';
        if (ratio === state.currentAspectRatio) btn.classList.add('active');
        btn.dataset.ratio = ratio;
        btn.textContent = ratio;
        const deleteBtn = document.createElement('div');
        deleteBtn.className = 'delete-ratio-btn';
        deleteBtn.innerHTML = '';
        deleteBtn.onclick = (e) => { e.stopPropagation(); deleteCustomRatio(ratio); };
        btn.appendChild(deleteBtn);
        btn.addEventListener('click', () => selectAspectRatio(ratio));
        grid.appendChild(btn);
    });

    // FIX: Custom button that transforms in place
    if (state.customAspectRatios.length < 9) {
        const customBtn = document.createElement('button');
        customBtn.className = 'aspect-btn custom-btn';
        customBtn.id = 'customAspectBtn';
        customBtn.textContent = 'Custom';
        customBtn.addEventListener('click', function() {
            // Transform the button itself
            this.classList.add('editing');
            this.innerHTML = `
                <input type="number" id="ratioWidth" placeholder="W" min="1" value="1">
                <span>:</span>
                <input type="number" id="ratioHeight" placeholder="H" min="1" value="1">
                <button class="btn btn-success" style="margin: 0;">Save</button>
            `;

            // Focus on first input
            document.getElementById('ratioWidth').focus();

            // Handle save button click
            this.querySelector('.btn-success').addEventListener('click', function(e) {
                e.stopPropagation();
                saveCustomRatioFromButton();
            });

            // Handle enter key
            this.querySelectorAll('input').forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveCustomRatioFromButton();
                    }
                });
            });
        });
        grid.appendChild(customBtn);
    }
}

function saveCustomRatioFromButton() {
    const w = parseInt(document.getElementById('ratioWidth').value) || 1;
    const h = parseInt(document.getElementById('ratioHeight').value) || 1;
    const ratio = `${w}:${h}`;

    if (state.customAspectRatios.includes(ratio)) {
        alert('Ratio already exists!');
        renderAspectRatios(); // Reset button
        return;
    }

    if (DEFAULT_ASPECT_RATIOS.includes(ratio)) {
        alert('This is a default ratio!');
        renderAspectRatios(); // Reset button
        return;
    }

    state.customAspectRatios.push(ratio);
    saveCustomAspectRatios();
    renderAspectRatios();
    selectAspectRatio(ratio);
}

window.saveCustomRatio = saveCustomRatioFromButton; // For backwards compatibility

function deleteCustomRatio(ratio) {
    if (!confirm(`Delete ${ratio} ratio?`)) return;
    state.customAspectRatios = state.customAspectRatios.filter(r => r !== ratio);
    saveCustomAspectRatios();
    if (state.currentAspectRatio === ratio) state.currentAspectRatio = '5:6';
    renderAspectRatios();
}

function selectAspectRatio(ratio) {
    state.currentAspectRatio = ratio;
    renderAspectRatios();
    if (state.activeElement) {
        const elementData = state.designElements.find(el => el.element === state.activeElement);
        if (elementData) applyAspectRatioToElement(elementData, ratio);
    }
}

function applyAspectRatioToElement(elementData, ratio) {
    elementData.data.aspectRatio = ratio;
    if (ratio !== 'free') {
        const ratioSplit = ratio.split(':');
        const w = parseInt(ratioSplit[0]);
        const h = parseInt(ratioSplit[1]);
        const currentWidth = elementData.data.width;
        const newHeight = (currentWidth * h) / w;
        state.activeElement.style.height = newHeight + 'px';
        elementData.data.height = newHeight;
    }
    generatePreviewDesign(elementData);
    triggerAutoSave(); // ADD THIS
}

async function loadWatermarks() {
    const grid = document.getElementById('watermarkGrid');
    grid.innerHTML = '';
    const noneOption = document.createElement('div');
    noneOption.className = 'watermark-option none selected';
    noneOption.dataset.watermarkId = 'none';
    noneOption.innerHTML = '<i class="fas fa-ban"></i><div style="font-size: 9px; margin-top: 3px;">None</div>';
    grid.appendChild(noneOption);
    for (let i = 0; i < LIBRARY_CONFIG.watermarks.files.length; i++) {
        const filename = LIBRARY_CONFIG.watermarks.files[i];
        const url = `${LIBRARY_CONFIG.watermarks.baseUrl}/${filename}`;
        const option = document.createElement('div');
        option.className = 'watermark-option';
        option.dataset.watermarkId = url;
        const img = document.createElement('img');
        img.src = url;
        img.alt = `Watermark ${i + 1}`;
        img.onerror = () => { option.innerHTML = '<i class="fas fa-image-slash"></i>'; };
        option.appendChild(img);
        grid.appendChild(option);
        try {
            const watermarkImg = await loadImage(url);
            state.watermarkImages[url] = watermarkImg;
        } catch (e) {}
    }
    document.querySelectorAll('.watermark-option').forEach(option => {
        option.addEventListener('click', function() {
            const watermarkId = this.dataset.watermarkId;
            selectWatermark(watermarkId === 'none' ? null : watermarkId);
        });
    });
}

function selectWatermark(url) {
    state.selectedWatermark = url;
    document.querySelectorAll('.watermark-option').forEach(el => { el.classList.remove('selected'); });
    if (url === null) document.querySelector('.watermark-option.none')?.classList.add('selected');
    else document.querySelector(`.watermark-option[data-watermark-id="${url}"]`)?.classList.add('selected');
    updateWatermarkPreview();
}

function drawCoverWatermark(ctx, watermarkImg, canvasWidth, canvasHeight, opacity) {
    if (!watermarkImg) return;
    ctx.save();
    ctx.globalAlpha = opacity;
    const wmWidth = watermarkImg.width;
    const wmHeight = watermarkImg.height;
    const canvasAspect = canvasWidth / canvasHeight;
    const wmAspect = wmWidth / wmHeight;
    let drawWidth, drawHeight, offsetX, offsetY;
    if (canvasAspect > wmAspect) {
        drawWidth = canvasWidth;
        drawHeight = canvasWidth / wmAspect;
        offsetX = 0;
        offsetY = (canvasHeight - drawHeight) / 2;
    } else {
        drawHeight = canvasHeight;
        drawWidth = canvasHeight * wmAspect;
        offsetX = (canvasWidth - drawWidth) / 2;
        offsetY = 0;
    }
    ctx.drawImage(watermarkImg, offsetX, offsetY, drawWidth, drawHeight);
    ctx.restore();
}

function updateWatermarkPreview() {
    const overlay = document.getElementById('watermarkPreviewOverlay');
    const canvas = document.getElementById('watermarkPreviewCanvas');
    const mockupPreview = document.getElementById('mockupPreview');

    if (!state.selectedWatermark || !state.watermarkImages[state.selectedWatermark]) {
        overlay.classList.remove('active');
        return;
    }

    if (!state.currentMockup) {
        overlay.classList.remove('active');
        return;
    }

    // FIXED: Get actual displayed size of mockup image
    const mockupRect = mockupPreview.getBoundingClientRect();
    const containerRect = document.getElementById('previewContainer').getBoundingClientRect();
    
    // Set canvas to match mockup's DISPLAYED size
    canvas.width = mockupRect.width;
    canvas.height = mockupRect.height;
    canvas.style.width = mockupRect.width + 'px';
    canvas.style.height = mockupRect.height + 'px';
    
    // FIXED: Position canvas to match mockup position
    canvas.style.position = 'absolute';
    canvas.style.left = (mockupRect.left - containerRect.left) + 'px';
    canvas.style.top = (mockupRect.top - containerRect.top) + 'px';

    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    const watermarkImg = state.watermarkImages[state.selectedWatermark];
    
    // Draw watermark at canvas size (already matches mockup display)
    drawCoverWatermark(ctx, watermarkImg, canvas.width, canvas.height, state.watermarkOpacity);

    overlay.classList.add('active');
}

function openLibraryModal() {
    document.getElementById('libraryModal').classList.add('active');
    state.selectedLibraryMockups.clear();
    updateLibrarySelectionInfo();
    renderLibraryCategories();
    const firstCategory = Object.keys(LIBRARY_CONFIG.categories)[0];
    if (firstCategory) loadLibraryCategory(firstCategory);
}

function renderLibraryCategories() {
    const container = document.getElementById('libraryCategories');
    container.innerHTML = '';
    for (const [categoryId, category] of Object.entries(LIBRARY_CONFIG.categories)) {
        const btn = document.createElement('div');
        btn.className = 'category-btn';
        btn.innerHTML = `<i class="fas ${category.icon}"></i><div>${category.name}</div><small style="color: var(--text-secondary); font-size: 10px;">${category.mockups.length} items</small>`;
        btn.onclick = () => loadLibraryCategory(categoryId);
        container.appendChild(btn);
    }
}

async function loadLibraryCategory(categoryId) {
    state.currentLibraryCategory = categoryId;
    state.selectedLibraryMockups.clear();
    updateLibrarySelectionInfo();
    document.querySelectorAll('.category-btn').forEach((btn, idx) => {
        btn.classList.toggle('active', Object.keys(LIBRARY_CONFIG.categories)[idx] === categoryId);
    });
    const category = LIBRARY_CONFIG.categories[categoryId];
    const container = document.getElementById('libraryMockups');
    const loadingState = document.getElementById('libraryLoadingState');
    container.style.display = 'none';
    loadingState.style.display = 'block';
    container.innerHTML = '';
    const existingFilenames = getMockupFilenamesInCurrentFolder();
    for (const mockupFile of category.mockups) {
        const thumbnailUrl = `${LIBRARY_CONFIG.baseUrl}/${category.thumbnailFolder}/${mockupFile}`;
        const fullQualityUrl = `${LIBRARY_CONFIG.baseUrl}/${categoryId}/${mockupFile}`;
        const item = document.createElement('div');
        item.className = 'library-mockup-item';
        item.dataset.mockupFile = mockupFile;
        item.dataset.categoryId = categoryId;
        item.dataset.fullQualityUrl = fullQualityUrl;
        if (existingFilenames.includes(mockupFile)) item.classList.add('already-added');
        const checkbox = document.createElement('div');
        checkbox.className = 'library-mockup-checkbox';
        checkbox.innerHTML = '<i class="fas fa-check"></i>';
        const img = document.createElement('img');
        img.className = 'library-mockup-img';
        img.src = thumbnailUrl;
        img.onerror = () => { img.src = fullQualityUrl; };
        const name = document.createElement('div');
        name.className = 'library-mockup-name';
        name.textContent = mockupFile.replace('.jpg', '').replace('.png', '');
        item.appendChild(checkbox);
        item.appendChild(img);
        item.appendChild(name);
        if (!item.classList.contains('already-added')) {
            item.onclick = () => toggleLibraryMockupSelection(item);
        }
        container.appendChild(item);
    }
    await new Promise(resolve => setTimeout(resolve, 200));
    loadingState.style.display = 'none';
    container.style.display = 'grid';
}

function toggleLibraryMockupSelection(item) {
    if (item.classList.contains('already-added')) return;
    const mockupId = `${item.dataset.categoryId}:${item.dataset.mockupFile}`;
    if (state.selectedLibraryMockups.has(mockupId)) {
        state.selectedLibraryMockups.delete(mockupId);
        item.classList.remove('selected');
    } else {
        state.selectedLibraryMockups.add(mockupId);
        item.classList.add('selected');
    }
    updateLibrarySelectionInfo();
}

function updateLibrarySelectionInfo() {
    const count = state.selectedLibraryMockups.size;
    document.getElementById('librarySelectionInfo').textContent = `${count} selected`;
    document.getElementById('addSelectedMockupsBtn').disabled = count === 0;
}

async function addMockupFromLibrary(url, filename) {
    const response = await fetch(url);
    const blob = await response.blob();
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async (e) => {
            const img = new Image();
            img.onload = async () => {
                const mockup = {
                    id: 'mockup_' + Date.now() + '_' + Math.random(),
                    name: filename,
                    dataUrl: e.target.result,
                    originalWidth: img.width,
                    originalHeight: img.height,
                    fromLibrary: true
                };
                await saveMockupToDB(mockup);
                state.mockups.push(mockup);
                state.mockupEnabled[mockup.id] = true;
                if (state.currentFolderId !== 'all') {
                    state.mockupToFolder[mockup.id] = state.currentFolderId;
                }
                saveFoldersToDB();
                renderFolderList();
                renderMockupList();
                updateStats();
                updateGenerateButton();
                resolve();
            };
            img.onerror = reject;
            img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(blob);
    });
}

async function loadMockupsFromDB() {
    try {
        state.mockups = await getAllMockupsFromDB();
        const savedData = localStorage.getItem('mckpsGen_positions');
        if (savedData) state.savedMockupData = JSON.parse(savedData);
        const enabledData = localStorage.getItem('mckpsGen_enabled');
        if (enabledData) state.mockupEnabled = JSON.parse(enabledData);
        else {
            state.mockups.forEach(m => {
                if (state.mockupEnabled[m.id] === undefined) state.mockupEnabled[m.id] = true;
            });
        }
    } catch (error) {}
}

async function updateStorageMeter() {
    try {
        const size = await getDBSize();
        const sizeMB = (size / (1024 * 1024)).toFixed(2);
        const limit = 500 * 1024 * 1024;
        const percent = Math.min((size / limit) * 100, 100);
        document.getElementById('storageSize').textContent = sizeMB + ' MB';
        document.getElementById('storagePercent').textContent = percent.toFixed(0) + '%';
        document.getElementById('storageFill').style.width = percent + '%';
        if (percent > 80) document.getElementById('storageFill').classList.add('warning');
        else document.getElementById('storageFill').classList.remove('warning');
    } catch (error) {}
}

function updateStats() {
    document.getElementById('mockupCount').textContent = state.mockups.length;
}

function savePositionsToStorage() {
    try { localStorage.setItem('mckpsGen_positions', JSON.stringify(state.savedMockupData)); } catch (e) {}
}

// GLOBAL - called from onclick
window.toggleMockup = function(mockupId) {
    const currentState = state.mockupEnabled[mockupId];
    state.mockupEnabled[mockupId] = !currentState;
    localStorage.setItem('mckpsGen_enabled', JSON.stringify(state.mockupEnabled));
    renderMockupList();
    updateGenerateButton();
};

// GLOBAL - called from onclick
window.deleteMockup = async function(mockupId) {
    if (!confirm('Delete this template?')) return;
    await deleteMockupSilently(mockupId);
    renderFolderList();
    renderMockupList();
    updateStats();
    updateGenerateButton();
    await updateStorageMeter();
};

async function deleteMockupSilently(mockupId) {
    try {
        await deleteMockupFromDB(mockupId);
        state.mockups = state.mockups.filter(m => m.id !== mockupId);
        for (const folderId in state.savedMockupData) {
            if (state.savedMockupData[folderId][mockupId]) {
                delete state.savedMockupData[folderId][mockupId];
            }
        }
        delete state.mockupToFolder[mockupId];
        savePositionsToStorage();
        saveFoldersToDB();
        if (state.currentMockup && state.currentMockup.id === mockupId) {
            state.currentMockup = null;
            document.getElementById('mockupPreview').classList.remove('visible');
            document.querySelector('.preview-placeholder').style.display = 'block';
            clearDesignElements();
            document.getElementById('addPngBtn').disabled = true;
        }
    } catch (error) {}
}

// GLOBAL - called from onclick
window.clearStorage = async function() {
    if (confirm('Clear all data?')) {
        try {
            await clearAllDB();
            localStorage.clear();
            state.mockups = [];
            state.savedMockupData = {};
            state.mockupEnabled = {};
            state.currentMockup = null;
            state.folders = [{ id: 'all', name: 'All Mockups', icon: 'fa-images', color: '#667eea' }];
            state.mockupToFolder = {};
            state.currentFolderId = 'all';
            state.selectedWatermark = null;
            state.customAspectRatios = [];
            clearDesignElements();
            renderFolderList();
            renderMockupList();
            renderAspectRatios();
            updateStats();
            updateCurrentFolderBadge();
            updateGenerateButton();
            await updateStorageMeter();
            await loadWatermarks();
            alert(' Cleared!');
        } catch (error) {}
    }
};

// GLOBAL - called from onclick
window.showMockupFolderMenu = function(mockupId, event) {
    event.stopPropagation();
    document.querySelectorAll('.folder-context-menu').forEach(el => el.remove());
    const menu = document.createElement('div');
    menu.className = 'folder-context-menu';
    menu.style.left = event.pageX + 'px';
    menu.style.top = event.pageY + 'px';
    for (const folder of state.folders) {
        const item = document.createElement('div');
        item.className = 'folder-context-menu-item';
        item.innerHTML = `<i class="fas ${folder.icon}" style="color: ${folder.color};"></i><span>${folder.name}</span>`;
        item.onclick = () => { assignMockupToFolder(mockupId, folder.id); menu.remove(); };
        menu.appendChild(item);
    }
    document.body.appendChild(menu);
    setTimeout(() => {
        document.addEventListener('click', function closeMenu() {
            menu.remove();
            document.removeEventListener('click', closeMenu);
        });
    }, 100);
};

async function handleMockupFiles(files) {
    for (const file of Array.from(files)) {
        if (mockupExistsInCurrentFolder(file.name)) {
            alert(`"${file.name}" already exists in this folder!`);
            continue;
        }
        try {
            const reader = new FileReader();
            reader.onload = async (e) => {
                const img = new Image();
                img.onload = async () => {
                    const mockup = {
                        id: 'mockup_' + Date.now() + '_' + Math.random(),
                        name: file.name,
                        dataUrl: e.target.result,
                        originalWidth: img.width,
                        originalHeight: img.height,
                        fromLibrary: false
                    };
                    await saveMockupToDB(mockup);
                    state.mockups.push(mockup);
                    state.mockupEnabled[mockup.id] = true;
                    if (state.currentFolderId !== 'all') {
                        state.mockupToFolder[mockup.id] = state.currentFolderId;
                    }
                    saveFoldersToDB();
                    renderFolderList();
                    renderMockupList();
                    updateStats();
                    updateGenerateButton();
                    await updateStorageMeter();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        } catch (error) {}
    }
}

function renderMockupList() {
    const mockupList = document.getElementById('mockupList');
    const mockupsToShow = getMockupsInFolder(state.currentFolderId);
    if (mockupsToShow.length === 0) {
        mockupList.innerHTML = '<li class="empty-state"><i class="fas fa-image"></i><p>No templates</p></li>';
        return;
    }
    mockupList.innerHTML = mockupsToShow.map(m => {
        const saved = state.savedMockupData[state.currentFolderId]?.[m.id];
        const elementCount = saved ? saved.elements.length : 0;
        const isEnabled = state.mockupEnabled[m.id] !== false;
        const libraryBadge = m.fromLibrary ? '<span class="library-badge">LIB</span>' : '';
        return `
            <li class="mockup-item ${state.currentMockup?.id === m.id ? 'selected' : ''} ${!isEnabled ? 'disabled' : ''}" data-id="${m.id}">
                <div class="mockup-name">
                    <i class="fas fa-image"></i>
                    <span>${m.name}</span>
                    ${libraryBadge}
                </div>
                <div style="display: flex; gap: 6px; align-items: center;">
                    ${elementCount > 0 ? `<div class="mockup-badge"><i class="fas fa-check"></i> ${elementCount}</div>` : ''}
                    <button class="mockup-folder-btn" onclick="event.stopPropagation(); showMockupFolderMenu('${m.id}', event)">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <div class="mockup-toggle ${isEnabled ? 'enabled' : ''}" onclick="event.stopPropagation(); toggleMockup('${m.id}')">
                        <div class="mockup-toggle-slider"></div>
                    </div>
                    <button class="delete-mockup-btn" onclick="event.stopPropagation(); deleteMockup('${m.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </li>
        `;
    }).join('');
    document.querySelectorAll('.mockup-item').forEach(item => {
        item.addEventListener('click', () => selectMockup(item.dataset.id));
    });
}

function updateSaveButton() {
    const saveBtn = document.getElementById('savePositionBtn');
    if (saveBtn) {
        saveBtn.disabled = state.designElements.length === 0;
    }
}

function selectMockup(id) {
    if (state.currentMockup && state.designElements.length > 0) { saveCurrentMockupElements(); }
    state.currentMockup = state.mockups.find(m => m.id === id);
    
    // ALWAYS clear elements first
    clearDesignElements();
    
    const mockupPreview = document.getElementById('mockupPreview');
    mockupPreview.src = state.currentMockup.dataUrl;
    mockupPreview.classList.add('visible');
    document.querySelector('.preview-placeholder').style.display = 'none';
    // clearDesignElements();
    if (state.savedMockupData[state.currentFolderId]?.[id]) {
    const savedData = state.savedMockupData[state.currentFolderId][id];
    mockupPreview.onload = () => {
        savedData.elements.forEach(elementData => {
            createDesignElement(elementData);
        });
        
        // ADD THIS: Regenerate previews after creating all elements
        state.designElements.forEach(el => {
            generatePreviewDesign(el);
        });
    };
} else {
        // Clear the onload handler for fresh mockups
        mockupPreview.onload = null;
    }
    document.getElementById('addPngBtn').disabled = false;
    document.getElementById('opacitySlider').disabled = false;

    document.getElementById('blendModeSelect').disabled = true;
document.getElementById('brightnessSlider').disabled = true;
document.getElementById('contrastSlider').disabled = true;
  
    renderMockupList();
    updateGenerateButton();
    setTimeout(() => updateWatermarkPreview(), 100);
    autoHideTemplatesPanel();
    updateSaveButton(); 
}

function createDesignElement(data) {
    const wrapper = document.createElement('div');
    wrapper.className = 'design-wrapper';
    wrapper.dataset.id = data.id;
    wrapper.style.left = data.left + 'px';
    wrapper.style.top = data.top + 'px';
    wrapper.style.width = data.width + 'px';
    wrapper.style.height = data.height + 'px';
    wrapper.style.transform = `rotate(${data.rotation}deg)`;
    wrapper.style.opacity = data.opacity;
    const elementNum = state.designElements.length + 1;
    wrapper.innerHTML = `
        <div class="element-label">Element ${elementNum}</div>
        <div class="design-placeholder">
            <i class="fas fa-layer-group" style="font-size: 1.4em; margin-bottom: 4px;"></i>
            <div>Design Area</div>
            <div style="font-size: 9px; margin-top: 2px;">${Math.round(data.width)}  ${Math.round(data.height)}</div>
        </div>
        <div class="resize-handle"></div>
        <div class="rotate-handle"><i class="fas fa-rotate"></i></div>
        <div class="remove-handle"></div>
    `;
    document.getElementById('previewContainer').appendChild(wrapper);
    state.designElements.push({ id: data.id, element: wrapper, data: data });

    generatePreviewDesign(state.designElements[state.designElements.length - 1]);
    
    setupElementInteractions(wrapper, data);
    wrapper.addEventListener('click', (e) => {
        if (!e.target.closest('.remove-handle')) { setActiveElement(wrapper); }
    });
    setActiveElement(wrapper);
    updateSaveButton();

    triggerAutoSave(); // ADD THIS LINE - Save when element added
}

function setActiveElement(wrapper) {
    document.querySelectorAll('.design-wrapper').forEach(w => w.classList.remove('active'));
    wrapper.classList.add('active');
    state.activeElement = wrapper;
    
    const elementData = state.designElements.find(el => el.element === wrapper);
    if (elementData) {
        document.getElementById('opacitySlider').value = elementData.data.opacity;
        document.getElementById('opacityValue').textContent = `${Math.round(elementData.data.opacity * 100)}%`;
        
        document.getElementById('blendModeSelect').value = elementData.data.blendMode || 'source-over';
        document.getElementById('brightnessSlider').value = elementData.data.brightness || 1.0;
        document.getElementById('brightnessValue').textContent = `${Math.round((elementData.data.brightness || 1.0) * 100)}%`;
        document.getElementById('contrastSlider').value = elementData.data.contrast || 1.0;
        document.getElementById('contrastValue').textContent = `${Math.round((elementData.data.contrast || 1.0) * 100)}%`;
        
        // MAKE SURE THESE ARE ENABLED
        document.getElementById('opacitySlider').disabled = false;
        document.getElementById('blendModeSelect').disabled = false;
        document.getElementById('brightnessSlider').disabled = false;
        document.getElementById('contrastSlider').disabled = false;
    }
}

function generatePreviewDesign(elementData) {
    const wrapper = elementData.element;
    
    // Create or get canvas
    let canvas = wrapper.querySelector('.design-preview-canvas');
    if (!canvas) {
        canvas = document.createElement('canvas');
        canvas.className = 'design-preview-canvas';
        canvas.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; pointer-events: none; z-index: 1;';
        wrapper.insertBefore(canvas, wrapper.firstChild);
    }
    
    // Hide the placeholder
    const placeholder = wrapper.querySelector('.design-placeholder');
    if (placeholder) {
        placeholder.style.display = 'none';
    }
    
    // Get mockup image
    const mockupImg = document.getElementById('mockupPreview');
    if (!mockupImg || !mockupImg.complete) {
        // Fallback if mockup not loaded yet
        return;
    }
    
    // Set canvas size to match wrapper dimensions
    const rect = wrapper.getBoundingClientRect();
    canvas.width = rect.width;
    canvas.height = rect.height;
    
    const ctx = canvas.getContext('2d', { alpha: true }); // CHANGE TO TRUE - need alpha for proper blending
ctx.clearRect(0, 0, canvas.width, canvas.height); // ADD THIS - clear before drawing
    
    // Get mockup and container positions to calculate what portion to show
    const mockupRect = mockupImg.getBoundingClientRect();
    const containerRect = document.getElementById('previewContainer').getBoundingClientRect();
    
    // Calculate source coordinates on the mockup image
    const sourceX = ((rect.left - mockupRect.left) / mockupRect.width) * mockupImg.naturalWidth;
    const sourceY = ((rect.top - mockupRect.top) / mockupRect.height) * mockupImg.naturalHeight;
    const sourceWidth = (rect.width / mockupRect.width) * mockupImg.naturalWidth;
    const sourceHeight = (rect.height / mockupRect.height) * mockupImg.naturalHeight;
    
    // 1. FIRST: Draw the portion of the mockup that's underneath this element
    ctx.drawImage(
        mockupImg,
        sourceX, sourceY, sourceWidth, sourceHeight,  // Source rectangle from mockup
        0, 0, canvas.width, canvas.height             // Destination (full canvas)
    );
    
    // 2. SECOND: Draw the preview design ON TOP with all effects
    ctx.save();
    
    // Apply opacity
    const opacity = elementData.data.opacity !== undefined ? elementData.data.opacity : 1.0;
    ctx.globalAlpha = opacity;
    
    // Apply blend mode (NOW it will blend with the mockup underneath!)
    const blendMode = elementData.data.blendMode || 'source-over';
    ctx.globalCompositeOperation = blendMode;
    
    // Apply brightness and contrast filters
    const brightness = elementData.data.brightness !== undefined ? elementData.data.brightness : 1.0;
    const contrast = elementData.data.contrast !== undefined ? elementData.data.contrast : 1.0;
    ctx.filter = `brightness(${brightness}) contrast(${contrast})`;
    
    // Draw the colored rectangle WITH all effects applied ON TOP of mockup
    ctx.fillStyle = '#6366f1';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // 3. THIRD: Draw text on top (always readable)
    ctx.filter = 'none';
    ctx.globalCompositeOperation = 'source-over';
    ctx.globalAlpha = 1.0;
    ctx.fillStyle = 'white';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.shadowColor = 'rgba(0, 0, 0, 0.7)';
    ctx.shadowBlur = 8;
    
    // Dynamic font size
    const fontSize = Math.min(canvas.width, canvas.height) * 0.2;
    ctx.font = `bold ${fontSize}px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif`;
    
    // Draw aspect ratio text
    const aspectText = elementData.data.aspectRatio === 'free' ? 'FREE' : elementData.data.aspectRatio.toUpperCase();
    ctx.fillText(aspectText, canvas.width / 2, canvas.height / 2);
    
    ctx.restore();
}
        
function setupElementInteractions(wrapper, data) {
    let isDragging = false, isResizing = false, isRotating = false;
    let startX, startY, initialLeft, initialTop, startWidth, startHeight;
    let centerX, centerY, startAngle, currentRotation = 0;
    wrapper.addEventListener('mousedown', (e) => {
        if (e.target.classList.contains('resize-handle') || 
            e.target.closest('.rotate-handle') ||
            e.target.closest('.remove-handle')) return;
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        initialLeft = parseInt(wrapper.style.left);
        initialTop = parseInt(wrapper.style.top);
        setActiveElement(wrapper);
        e.preventDefault();
    });
    document.addEventListener('mousemove', (e) => {
        if (isDragging) {
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            wrapper.style.left = (initialLeft + dx) + 'px';
            wrapper.style.top = (initialTop + dy) + 'px';
            data.left = parseInt(wrapper.style.left);
            data.top = parseInt(wrapper.style.top);
            generatePreviewDesign({ element: wrapper, data: data });
            triggerAutoSave(); // ADD THIS LINE
        }
        if (isResizing) {
            const dx = e.clientX - startX;
            let newWidth = Math.max(50, startWidth + dx);
            let newHeight;
            if (data.aspectRatio !== 'free') {
                const ratio = data.aspectRatio.split(':');
                const w = parseInt(ratio[0]);
                const h = parseInt(ratio[1]);
                newHeight = (newWidth * h) / w;
            } else {
                newHeight = Math.max(50, startHeight + (dx * (startHeight / startWidth)));
            }
            wrapper.style.width = newWidth + 'px';
            wrapper.style.height = newHeight + 'px';
            data.width = newWidth;
            data.height = newHeight;
            generatePreviewDesign({ element: wrapper, data: data });
            triggerAutoSave(); // ADD THIS LINE
        }
        if (isRotating) {
            const angle = Math.atan2(e.clientY - centerY, e.clientX - centerX);
            const rotation = currentRotation + (angle - startAngle) * (180 / Math.PI);
            wrapper.style.transform = `rotate(${rotation}deg)`;
            data.rotation = rotation;
            triggerAutoSave(); //  ADD THIS LINE
        }
    });
    document.addEventListener('mouseup', () => {
    // Check if any action was happening before releasing
    const wasInteracting = isDragging || isResizing || isRotating;
    
    isDragging = isResizing = isRotating = false;
    
    // Trigger auto-save if user was manipulating an element
    if (wasInteracting) {
        triggerAutoSave();
    }
});
    wrapper.querySelector('.resize-handle').addEventListener('mousedown', (e) => {
        isResizing = true;
        startX = e.clientX;
        startWidth = parseInt(wrapper.style.width);
        startHeight = parseInt(wrapper.style.height);
        e.stopPropagation();
        e.preventDefault();
    });
    wrapper.querySelector('.rotate-handle').addEventListener('mousedown', (e) => {
        isRotating = true;
        const rect = wrapper.getBoundingClientRect();
        centerX = rect.left + rect.width / 2;
        centerY = rect.top + rect.height / 2;
        startAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX);
        const match = wrapper.style.transform.match(/rotate\(([^)]+)deg\)/);
        currentRotation = match ? parseFloat(match[1]) : 0;
        e.stopPropagation();
        e.preventDefault();
    });
    wrapper.querySelector('.remove-handle').addEventListener('click', () => {
        wrapper.remove();
        state.designElements = state.designElements.filter(e => e.id !== data.id);
    
        // Save immediately
        if (state.currentMockup) {
            saveCurrentMockupElements();
            savePositionsToStorage();  // Saves to localStorage
        }
        
        // Update UI
        renderMockupList();        // Updates badge visibility
        updateGenerateButton();    // Updates "Generate X" count
        updateSaveButton();
        
        // Clear active element if it was this one
        if (state.activeElement === wrapper) {
            state.activeElement = null;
        }
    });
}

function clearDesignElements() {
    document.querySelectorAll('.design-wrapper').forEach(el => el.remove());
    state.designElements = [];
    state.activeElement = null;
}

// ADD THIS ENTIRE FUNCTION
function triggerAutoSave() {
    // Clear existing timeout
    if (autoSaveTimeout) {
        clearTimeout(autoSaveTimeout);
    }
    
    // Set new timeout
    autoSaveTimeout = setTimeout(() => {
        if (state.currentMockup) {
            saveCurrentMockupElements();
            savePositionsToStorage();     // ADD THIS - Persist to localStorage
            renderMockupList();            // Updates badge
            updateGenerateButton();        // ADD THIS - Enable Generate button
            
            // Show "Saved" indicator
            const indicator = document.getElementById('autoSaveIndicator');
            if (indicator) {
                indicator.style.opacity = '1';
                setTimeout(() => { indicator.style.opacity = '0'; }, 2000);
            }
        }
    }, AUTO_SAVE_DELAY);
}

function saveCurrentMockupElements() {
    if (!state.currentMockup) return;
    const mockupPreview = document.getElementById('mockupPreview');
    const previewContainer = document.getElementById('previewContainer');
    const mockupRect = mockupPreview.getBoundingClientRect();
    const containerRect = previewContainer.getBoundingClientRect();
    if (!state.savedMockupData[state.currentFolderId]) {
        state.savedMockupData[state.currentFolderId] = {};
    }
    state.savedMockupData[state.currentFolderId][state.currentMockup.id] = {
        elements: state.designElements.map(el => ({...el.data})),
        previewBounds: {
            width: mockupRect.width,
            height: mockupRect.height,
            left: mockupRect.left - containerRect.left,
            top: mockupRect.top - containerRect.top
        }
    };
}

function updateGenerateButton() {
    const mockupsInCurrentFolder = getMockupsInFolder(state.currentFolderId);
    const enabledInFolder = mockupsInCurrentFolder.filter(m => {
        const mockupData = state.savedMockupData[state.currentFolderId]?.[m.id];
        return state.mockupEnabled[m.id] !== false &&
               mockupData &&
               mockupData.elements &&
               mockupData.elements.length > 0;  // Check elements array length
    });
    const hasData = enabledInFolder.length > 0;
    
    document.getElementById('loadExportBtn').disabled = !hasData;
    const btn = document.getElementById('loadExportBtn');
    if (hasData) {
        const count = enabledInFolder.length;
        btn.innerHTML = `<i class="fas fa-rocket"></i><span>Generate ${count}</span>`;
    } else {
        btn.innerHTML = `<i class="fas fa-rocket"></i><span>Generate</span>`;
    }
}

function readFileAsDataURL(file) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.readAsDataURL(file);
    });
}

function loadImage(src) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = () => reject(new Error('Failed to load: ' + src));
        img.crossOrigin = 'anonymous';
        img.src = src;
    });
}

window.addEventListener('load', async () => {
    try {
        await initDB();
        await loadMockupsFromDB();
        loadFoldersFromDB();
        loadCustomAspectRatios();
        await loadWatermarks();
        await updateStorageMeter();
        renderFolderList();
        renderMockupList();
        renderAspectRatios();
        updateStats();
        updateCurrentFolderBadge();
        updateGenerateButton();
        initTemplatesPanel();

        document.getElementById('mockupFilesInput')?.addEventListener('change', (e) => {
            handleMockupFiles(e.target.files);
        });

        document.getElementById('uploadDesktopBtn')?.addEventListener('click', () => {
            document.getElementById('mockupFilesInput').click();
        });

        document.getElementById('browseLibraryBtn')?.addEventListener('click', openLibraryModal);
        document.getElementById('closeLibraryModal')?.addEventListener('click', () => {
            document.getElementById('libraryModal').classList.remove('active');
        });

        document.getElementById('addFolderBtnInline')?.addEventListener('click', () => {
            const modal = document.getElementById('folderModal');
            const input = document.getElementById('folderNameInput');
            modal.classList.add('active');
            input.value = '';
            input.focus();
            selectedFolderIcon = 'fa-folder';
            selectedFolderColor = '#667eea';
            document.querySelectorAll('.folder-icon-option').forEach(el => {
                el.classList.toggle('selected', el.dataset.icon === 'fa-folder');
            });
            document.querySelectorAll('.folder-color-option').forEach(el => {
                el.classList.toggle('selected', el.dataset.color === '#667eea');
            });
        });

        document.getElementById('cancelFolderBtn')?.addEventListener('click', () => {
            document.getElementById('folderModal')?.classList.remove('active');
        });

        document.getElementById('createFolderBtn')?.addEventListener('click', () => {
            const input = document.getElementById('folderNameInput');
            const name = input?.value.trim();
            if (!name) { alert('Enter folder name'); return; }
            const folderId = createFolder(name, selectedFolderIcon, selectedFolderColor);
            document.getElementById('folderModal')?.classList.remove('active');
            switchFolder(folderId);
        });

        document.querySelectorAll('.folder-icon-option').forEach(el => {
            el.addEventListener('click', () => {
                document.querySelectorAll('.folder-icon-option').forEach(e => e.classList.remove('selected'));
                el.classList.add('selected');
                selectedFolderIcon = el.dataset.icon;
            });
        });

        document.querySelectorAll('.folder-color-option').forEach(el => {
            el.addEventListener('click', () => {
                document.querySelectorAll('.folder-color-option').forEach(e => e.classList.remove('selected'));
                el.classList.add('selected');
                selectedFolderColor = el.dataset.color;
            });
        });

        document.getElementById('folderNameInput')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') { document.getElementById('createFolderBtn')?.click(); }
        });

        document.getElementById('watermarksToggle')?.addEventListener('click', function(e) {
            const content = document.getElementById('watermarksContent');
            this.classList.toggle('collapsed');
            content.classList.toggle('collapsed');
        });

        document.getElementById('watermarkOpacitySlider')?.addEventListener('input', (e) => {
            state.watermarkOpacity = parseFloat(e.target.value);
            document.getElementById('watermarkOpacityValue').textContent = Math.round(state.watermarkOpacity * 100) + '%';
            updateWatermarkPreview();
        });

        document.getElementById('addPngBtn')?.addEventListener('click', () => {
            if (!state.currentMockup) return;
            const mockupPreview = document.getElementById('mockupPreview');
            const previewContainer = document.getElementById('previewContainer');
            const mockupRect = mockupPreview.getBoundingClientRect();
            const containerRect = previewContainer.getBoundingClientRect();
            let width = 200, height = 200;
            if (state.currentAspectRatio !== 'free') {
                const ratio = state.currentAspectRatio.split(':');
                const w = parseInt(ratio[0]);
                const h = parseInt(ratio[1]);
                width = 200;
                height = (width * h) / w;
            }
            const elementData = {
                id: 'element_' + (++elementIdCounter),
                left: mockupRect.left - containerRect.left + 50,
                top: mockupRect.top - containerRect.top + 50,
                width: width,
                height: height,
                rotation: 0,
                opacity: 1.0,
                aspectRatio: state.currentAspectRatio,
              
                blendMode: state.defaultBlendMode,
                brightness: state.defaultBrightness,
                contrast: state.defaultContrast
            };
            createDesignElement(elementData);
            document.getElementById('savePositionBtn').disabled = false;
        });

        document.getElementById('opacitySlider')?.addEventListener('input', (e) => {
    const opacity = parseFloat(e.target.value);
    document.getElementById('opacityValue').textContent = `${Math.round(opacity * 100)}%`;
    if (state.activeElement) {
        const elementData = state.designElements.find(el => el.element === state.activeElement);
        if (elementData) {
            elementData.data.opacity = opacity;
            generatePreviewDesign(elementData);
            triggerAutoSave(); // ADD THIS
        }
    }
});

document.getElementById('blendModeSelect')?.addEventListener('change', (e) => {
    const blendMode = e.target.value;
    if (state.activeElement) {
        const elementData = state.designElements.find(el => el.element === state.activeElement);
        if (elementData) {
            elementData.data.blendMode = blendMode;
            generatePreviewDesign(elementData);
            triggerAutoSave(); // ADD THIS
        }
    }
});

document.getElementById('brightnessSlider')?.addEventListener('input', (e) => {
    const brightness = parseFloat(e.target.value);
    document.getElementById('brightnessValue').textContent = `${Math.round(brightness * 100)}%`;
    if (state.activeElement) {
        const elementData = state.designElements.find(el => el.element === state.activeElement);
        if (elementData) {
            elementData.data.brightness = brightness;
            generatePreviewDesign(elementData);
            triggerAutoSave(); // ADD THIS
        }
    }
});

document.getElementById('contrastSlider')?.addEventListener('input', (e) => {
    const contrast = parseFloat(e.target.value);
    document.getElementById('contrastValue').textContent = `${Math.round(contrast * 100)}%`;
    if (state.activeElement) {
        const elementData = state.designElements.find(el => el.element === state.activeElement);
        if (elementData) {
            elementData.data.contrast = contrast;
            generatePreviewDesign(elementData);
            triggerAutoSave(); // ADD THIS
        }
    }
});

        document.getElementById('savePositionBtn')?.addEventListener('click', () => {
            if (!state.currentMockup || state.designElements.length === 0) return;
            saveCurrentMockupElements();
            savePositionsToStorage();
            renderMockupList();
            updateGenerateButton();
            alert(' Saved!');
        });

        document.getElementById('selectAllBtn')?.addEventListener('click', () => {
            document.querySelectorAll('.library-mockup-item:not(.already-added)').forEach(item => {
                const mockupId = `${item.dataset.categoryId}:${item.dataset.mockupFile}`;
                state.selectedLibraryMockups.add(mockupId);
                item.classList.add('selected');
            });
            updateLibrarySelectionInfo();
        });

        document.getElementById('deselectAllBtn')?.addEventListener('click', () => {
            state.selectedLibraryMockups.clear();
            document.querySelectorAll('.library-mockup-item').forEach(item => {
                item.classList.remove('selected');
            });
            updateLibrarySelectionInfo();
        });

        document.getElementById('addSelectedMockupsBtn')?.addEventListener('click', async () => {
            if (state.selectedLibraryMockups.size === 0) return;
            const progressModal = document.getElementById('progressModal');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            progressModal.classList.add('active');
            const selectedMockups = Array.from(state.selectedLibraryMockups);
            const total = selectedMockups.length;
            let completed = 0;
            for (const mockupId of selectedMockups) {
                const [categoryId, mockupFile] = mockupId.split(':');
                const fullQualityUrl = `${LIBRARY_CONFIG.baseUrl}/${categoryId}/${mockupFile}`;
                progressText.textContent = `${mockupFile}... (${completed + 1}/${total})`;
                progressFill.style.width = `${Math.round((completed / total) * 100)}%`;
                progressFill.textContent = `${Math.round((completed / total) * 100)}%`;
                try {
                    await addMockupFromLibrary(fullQualityUrl, mockupFile);
                    completed++;
                } catch (error) {
                    completed++;
                }
                progressFill.style.width = `${Math.round((completed / total) * 100)}%`;
                progressFill.textContent = `${Math.round((completed / total) * 100)}%`;
            }
            await updateStorageMeter();
            progressModal.classList.remove('active');
            document.getElementById('libraryModal').classList.remove('active');
        });

        document.getElementById('loadExportBtn')?.addEventListener('click', () => {
            document.getElementById('designPngsInput').click();
        });

        document.getElementById('designPngsInput')?.addEventListener('change', async (e) => {
            const pngFiles = Array.from(e.target.files);
            if (pngFiles.length === 0) return;
            const progressModal = document.getElementById('progressModal');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            progressModal.classList.add('active');
            const mockupsInCurrentFolder = getMockupsInFolder(state.currentFolderId);
            const mockupsWithData = mockupsInCurrentFolder
            .filter(m => {
                const mockupData = state.savedMockupData[state.currentFolderId]?.[m.id];
                return state.mockupEnabled[m.id] !== false && 
                       mockupData && 
                       mockupData.elements && 
                       mockupData.elements.length > 0;  // ADD THIS CHECK
            })
            .map(m => m.id);
            if (mockupsWithData.length === 0) {
                progressModal.classList.remove('active');
                alert('No templates ready!');
                return;
            }
            const total = pngFiles.length * mockupsWithData.length;
            let completed = 0;
            const zip = new JSZip();
            for (const pngFile of pngFiles) {
                const pngDataUrl = await readFileAsDataURL(pngFile);
                const pngImg = await loadImage(pngDataUrl);
                for (const mockupId of mockupsWithData) {
                    const mockup = state.mockups.find(m => m.id === mockupId);
                    const savedData = state.savedMockupData[state.currentFolderId][mockupId];
                    const mockupImg = await loadImage(mockup.dataUrl);
                    const canvas = document.createElement('canvas');
                    canvas.width = mockup.originalWidth;
                    canvas.height = mockup.originalHeight;
                    const isPNG = mockup.name.toLowerCase().endsWith('.png');
                    const ctx = canvas.getContext('2d', { alpha: isPNG });
                    ctx.drawImage(mockupImg, 0, 0, mockup.originalWidth, mockup.originalHeight);
                    const scaleX = mockup.originalWidth / savedData.previewBounds.width;
                    const scaleY = mockup.originalHeight / savedData.previewBounds.height;
                    for (const element of savedData.elements) {
    ctx.save();
    const scaledLeft = (element.left - savedData.previewBounds.left) * scaleX;
    const scaledTop = (element.top - savedData.previewBounds.top) * scaleY;
    const scaledWidth = element.width * scaleX;
    const scaledHeight = element.height * scaleY;
    
    ctx.globalAlpha = element.opacity;
    // MAKE SURE THIS LINE EXISTS
    ctx.globalCompositeOperation = element.blendMode || 'source-over';
    
    ctx.translate(scaledLeft + scaledWidth/2, scaledTop + scaledHeight/2);
    ctx.rotate(element.rotation * Math.PI / 180);
    
    // MAKE SURE THESE LINES EXIST
    const brightness = element.brightness || 1.0;
    const contrast = element.contrast || 1.0;
    ctx.filter = `brightness(${brightness}) contrast(${contrast})`;
    
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = 'high';
    ctx.drawImage(pngImg, -scaledWidth/2, -scaledHeight/2, scaledWidth, scaledHeight);
    
    // MAKE SURE THIS LINE EXISTS
    ctx.filter = 'none';
    ctx.restore();
}
                  
                    if (state.selectedWatermark && state.watermarkImages[state.selectedWatermark]) {
                        const watermarkImg = state.watermarkImages[state.selectedWatermark];
                        drawCoverWatermark(ctx, watermarkImg, mockup.originalWidth, mockup.originalHeight, state.watermarkOpacity);
                    }
                    const baseName = pngFile.name.replace(/\.(png|jpg|jpeg)$/i, '');
                    let dataUrl, finalFileName;
                    if (isPNG) {
                        dataUrl = canvas.toDataURL('image/png');
                        finalFileName = `${baseName}_${mockup.name}`;
                    } else {
                        dataUrl = canvas.toDataURL('image/jpeg', 1.0);
                        const mockupBaseName = mockup.name.replace(/\.(png|jpg|jpeg)$/i, '');
                        finalFileName = `${baseName}_${mockupBaseName}.jpg`;
                    }
                    const base64 = dataUrl.split(',')[1];
                    zip.file(finalFileName, base64, { base64: true });
                    completed++;
                    const progress = Math.round((completed / total) * 100);
                    progressFill.style.width = progress + '%';
                    progressFill.textContent = progress + '%';
                    progressText.textContent = `${completed} of ${total}...`;
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
            }
            if (total === 1) {
                progressText.textContent = 'Downloading...';
                const firstFile = zip.file(Object.keys(zip.files)[0]);
                const base64Data = await firstFile.async('base64');
                const link = document.createElement('a');
                link.download = Object.keys(zip.files)[0];
                link.href = 'data:image/png;base64,' + base64Data;
                link.click();
                setTimeout(() => {
                    progressModal.classList.remove('active');
                    document.getElementById('designPngsInput').value = '';
                }, 500);
            } else {
                progressText.textContent = 'Creating ZIP...';
                const blob = await zip.generateAsync({ type: 'blob' });
                const link = document.createElement('a');
                const folderName = state.folders.find(f => f.id === state.currentFolderId)?.name || 'mockups';
                link.download = `${folderName.replace(/\s+/g, '_')}_${Date.now()}.zip`;
                link.href = URL.createObjectURL(blob);
                link.click();
                setTimeout(() => {
                    progressModal.classList.remove('active');
                    document.getElementById('designPngsInput').value = '';
                }, 500);
            }
        });

        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

    } catch (error) {
        console.error('Init failed:', error);
        alert('Initialization failed');
    }
});
        </script>
</body>
</html>
